<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abhyaas ‚Ä¢ Reading Fluency Checker (Premium)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900;1000&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Inter,system-ui,Arial;}

    :root{
      --bg1:#eefbff;
      --bg2:#dff3ff;
      --bg3:#f6feff;

      --card:rgba(255,255,255,.62);
      --card2:rgba(255,255,255,.42);
      --border:rgba(10,50,110,.12);

      --text:#072a45;
      --muted:#3c6c95;

      --a1:#5ad3ff;
      --a2:#1d9bf0;
      --a3:#0b5bb8;

      --ok:#22c55e;
      --warn:#f97316;
      --bad:#ef4444;

      --shadow: 0 25px 80px rgba(0,30,80,.12);
      --shadow2: 0 30px 95px rgba(0,30,80,.14);
    }

    body{
      min-height:100vh;
      color:var(--text);
      padding:20px;
      overflow:hidden;

      background: linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3), #d7f1ff);
      background-size: 420% 420%;
      animation: bgmove 14s ease infinite;
    }
    @keyframes bgmove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* floating particles */
    .particles{position:fixed; inset:0; pointer-events:none; opacity:.85; z-index:-1;}
    .particles span{
      position:absolute;
      width:10px;height:10px;border-radius:50%;
      background:rgba(255,255,255,.95);
      box-shadow: 0 0 18px rgba(90,211,255,.55);
      animation: floaty 9s ease-in-out infinite;
      
    }
    @keyframes floaty{
      0%,100%{transform:translateY(0) translateX(0); opacity:.55}
      50%{transform:translateY(-35px) translateX(25px); opacity:1}
    }
    .particles span{ width:30px; height:50px; }


    .float-icons{position:fixed; inset:0; pointer-events:none; opacity:.75; z-index:-1;}
    .float-icons i{
      position:absolute;
      font-style:normal;
      font-size:22px;
      animation: floatIcon 8s ease-in-out infinite;
    }
    .particles span.left{ left: 3% !important; }
    .particles span.right{ left: 96% !important; }
    @keyframes floatIcon{
      0%,100%{transform:translateY(0) rotate(0deg); opacity:.55}
      50%{transform:translateY(-30px) rotate(7deg); opacity:1}
    }

    .wrap{max-width:1180px;margin:0 auto;}

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;

      border-radius:22px;
      background: rgba(255,255,255,0.40);
      border:1px solid var(--border);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
      padding:16px 16px;
    }

    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:52px;height:52px;border-radius:20px;
      background: linear-gradient(135deg,var(--a1),var(--a2),var(--a3));
      box-shadow: 0 22px 70px rgba(29,155,240,.22);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#fff;
      position:relative; overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-60%;
      background: radial-gradient(circle, rgba(255,255,255,.65), transparent 60%);
      animation: shine 3s linear infinite;
    }
    @keyframes shine{
      0%{transform:translateX(-45%)}
      100%{transform:translateX(45%)}
    }

    .brand h1{font-size:18px;font-weight:1000;line-height:1;}
    .brand p{font-size:12px;color:var(--muted);font-weight:900;margin-top:4px;}

    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(10,50,110,.10);
      font-size:12px;
      font-weight:700;
      color:#0b5bb8;
      box-shadow: 0 14px 40px rgba(0,30,80,.06);
    }

    /* Typing word */
    .typing{
      display:inline-block;
      font-weight:700;
      background: linear-gradient(90deg, var(--a3), var(--a2), var(--a1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .cursor{
      display:inline-block;
      width:10px;
      height:18px;
      margin-left:6px;
      border-radius:4px;
      background:var(--a2);
      animation: blink 1s infinite;
      transform: translateY(2px);
    }
    @keyframes blink{50%{opacity:0}}

    /* Grid */
    .grid{display:grid;grid-template-columns: 440px 1fr;gap:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 18px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(16px);
      transition: .25s ease;
      position:relative;
      overflow:hidden;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 35px 110px rgba(29,155,240,.16);
    }

    /* Premium corner glow */
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle, rgba(90,211,255,.25), transparent 55%);
      opacity:.55;
      pointer-events:none;
      transition:.25s ease;
    }
    .card:hover::before{opacity:1}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;font-weight:900;}

    select, input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(10,50,110,.12);
      background: rgba(255,255,255,.65);
      color:var(--text);
      outline:none;
      transition:.2s ease;
      font-weight:700;
    }
    select:focus, input:focus, textarea:focus{
      border-color: rgba(29,155,240,.55);
      box-shadow:0 0 0 4px rgba(29,155,240,.15);
      transform: translateY(-1px);
    }
    textarea{min-height:160px;resize:vertical;line-height:1.6;}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    .btn{
      width:100%;
      padding:13px 14px;
      border-radius:16px;
      border:0;
      cursor:pointer;
      font-weight:1000;
      color:#fff;
      background: linear-gradient(135deg,var(--a1),var(--a2),var(--a3));
      transition:.22s ease;
      box-shadow: 0 25px 85px rgba(29,155,240,.22);
      position:relative;
      overflow:hidden;
    }
    .btn::after{
      content:"";
      position:absolute;
      top:-40%;
      left:-40%;
      width:80%;
      height:200%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      transform: rotate(20deg);
      opacity:0;
      transition:.35s ease;
    }
    .btn:hover{transform: translateY(-2px) scale(1.01)}
    .btn:hover::after{opacity:1; left:120%}

    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .btn.secondary{
      background: rgba(255,255,255,.55);
      color:#0b5bb8;
      border:1px solid rgba(10,50,110,.12);
      box-shadow: 0 18px 55px rgba(0,30,80,.06);
    }

    .btn.danger{
      background: rgba(239,68,68,.12);
      color:#b91c1c;
      border:1px solid rgba(239,68,68,.25);
      box-shadow: 0 18px 55px rgba(239,68,68,.08);
    }

    .divider{height:1px;background:rgba(10,50,110,.10);margin:14px 0;}

    .muted{color:var(--muted);font-size:12px;font-weight:900;}

    /* Loading */
    .loading{
      display:none;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      margin-top:8px;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:linear-gradient(135deg,var(--a1),var(--a2),var(--a3));
      animation: pulse 1s infinite;
      box-shadow:0 0 18px rgba(29,155,240,.35);
    }
    @keyframes pulse{
      0%{transform:scale(1);opacity:.6}
      50%{transform:scale(1.6);opacity:1}
      100%{transform:scale(1);opacity:.6}
    }

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;max-width:360px;z-index:9999}
    .toast .t{
      margin-top:10px;
      padding:12px 14px;
      border-radius:18px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(10,50,110,.12);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      font-weight:700;
      color:#0b5bb8;
      transition:.25s ease;
    }

    .bigNum{
      font-size:30px;
      font-weight:700;
      background: linear-gradient(90deg, var(--a3), var(--a2), var(--a1));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    /* Right result area */
    .outWrap{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .resultCard{
      background: rgba(255,255,255,.55);
      border:1px solid rgba(10,50,110,.10);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 20px 70px rgba(0,30,80,.08);
    }
    .resultCard h3{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.7px;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .resultText{
      line-height:1.75;
      font-weight:700;
      color:#08304f;
      white-space:pre-wrap;
    }

    .badgeOk{
      background: rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.22);
      color:#15803d;
    }
    .badgeWarn{
      background: rgba(249,115,22,.12);
      border:1px solid rgba(249,115,22,.22);
      color:#c2410c;
    }
    .badgeBad{
      background: rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.22);
      color:#b91c1c;
    }
  </style>
</head>

<body>

  <div class="particles">
    <span class="left" style="top:10%;animation-delay:.2s"></span>
    <span class="right" style="top:18%;animation-delay:1.2s"></span>
    <span class="left" style="top:55%;animation-delay:2.0s"></span>
    <span class="right" style="top:70%;animation-delay:2.7s"></span>
    <span class="left" style="top:86%;animation-delay:1.7s"></span>
    <span class="right" style="top:40%;animation-delay:.8s"></span>

  </div>

  <div class="float-icons">
    <i style="top:12%;left:14%;animation-delay:.1s">‚ú®</i>
    <i style="top:18%;left:78%;animation-delay:1.1s">üìò</i>
    <i style="top:55%;left:10%;animation-delay:2.0s">üß†</i>
    <i style="top:72%;left:88%;animation-delay:2.7s">üéô</i>
    <i style="top:84%;left:34%;animation-delay:1.7s">üìÑ</i>
    <i style="top:40%;left:56%;animation-delay:.8s">ü§ñ</i>
  </div>

  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <h1>Abhyaas ‚Ä¢ AI Reading Fluency Checker</h1>
          <p>
            <span class="typing" id="typingWord">Generate Passage</span><span class="cursor"></span>
            &nbsp;‚Üí Record ‚Üí AI Score ‚Üí Teacher Feedback
          </p>
        </div>
      </div>

      <div class="topRight">
        <div class="pill" id="apiStatus">üîå Backend: Checking...</div>
        <div class="pill">‚ö° Fast</div>
        <div class="pill">üìÑ Classroom-ready</div>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div style="display:flex;flex-direction:column;gap:10px;position:relative;z-index:1;">

          <div class="row">
            <div>
              <label>Class</label>
              <select id="classSel">
                <option value="" selected disabled>Select class</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>

            </div>
            <div>
              <label>Language</label>
              <select id="langSel">
                 <option value="" selected disabled>Select language</option>
                <option>Hindi</option>
                <option>English</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Level</label>
              <select id="levelSel">
                <option value="" selected disabled>Select level</option>
                <option>Easy</option>
                <option>Medium</option>
              </select>
            </div>
            <div>
              <label>Chapter</label>
              <input id="chapterInput" placeholder="Ex - Mughal Empire"/>
            </div>
          </div>

          <button class="btn" id="genBtn">üìñ Generate Passage</button>

          <div class="divider"></div>

          <label>Reading Passage</label>
          <textarea id="passageBox" placeholder="Generate passage first..."></textarea>

          <div class="row">
            <button class="btn secondary" id="startBtn">üéô Start Recording</button>
            <button class="btn danger" id="stopBtn" disabled>‚èπ Stop</button>
          </div>

          <button class="btn" id="checkBtn" disabled>‚úÖ Check Fluency</button>

          <div class="loading" id="loading">
            <div class="dot"></div>
            <div id="loadingText">Working...</div>
          </div>

          <div class="muted">
            Tip: Baccha 20‚Äì40 seconds tak padhe. Clear voice best. (Mic permission allow karna)
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="outWrap" id="out">
          <div class="muted">Generate passage, then record and check fluency.</div>

          <div class="resultCard">
            <h3>What this tool checks</h3>
            <div class="resultText">
‚Ä¢ Pronunciation accuracy
‚Ä¢ Missing / extra words
‚Ä¢ Reading speed (WPM)
‚Ä¢ Fluency rating (Easy / Medium / Needs Improvement)
‚Ä¢ Teacher feedback for next improvement
            </div>
          </div>

          <div class="resultCard">
            <h3>Premium classroom features</h3>
            <div class="resultText">
‚Ä¢ Works in Hindi + English
‚Ä¢ Supports grade-wise passages
‚Ä¢ AI gives instant feedback (no manual checking)
‚Ä¢ Perfect for 1:1 reading assessment
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>
<script src="../config.js"></script>

<script>
  console.log("CONFIG:", window.APP_CONFIG);
</script>
<script>
  const API_BASE = window.APP_CONFIG?.API_BASE || "https://backend-abhyaas-final.onrender.com";

  const apiStatus = document.getElementById("apiStatus");

  const classSel = document.getElementById("classSel");
  const langSel = document.getElementById("langSel");
  const levelSel = document.getElementById("levelSel");
  const chapterInput = document.getElementById("chapterInput");

  const genBtn = document.getElementById("genBtn");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const checkBtn = document.getElementById("checkBtn");

  const passageBox = document.getElementById("passageBox");
  const out = document.getElementById("out");

  const loading = document.getElementById("loading");
  const loadingText = document.getElementById("loadingText");

  let mediaRecorder = null;
  let audioChunks = [];
  let recordedBlob = null;
  let recordStartTime = null;
  let durationSeconds = 0;

  /* Typing header */
  const words = ["Generate Passage", "Record Voice", "AI Scoring", "Teacher Feedback"];
  let wi = 0, ci = 0, deleting = false;
  function typeLoop(){
    const el = document.getElementById("typingWord");
    const word = words[wi];
    if(!deleting){
      ci++;
      el.textContent = word.substring(0, ci);
      if(ci === word.length){
        deleting = true;
        setTimeout(typeLoop, 900);
        return;
      }
    }else{
      ci--;
      el.textContent = word.substring(0, ci);
      if(ci === 0){
        deleting = false;
        wi = (wi + 1) % words.length;
      }
    }
    setTimeout(typeLoop, deleting ? 55 : 75);
  }
  typeLoop();

  function toast(msg){
    const wrap = document.getElementById("toast");
    const el = document.createElement("div");
    el.className = "t";
    el.textContent = msg;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity = "0"; el.style.transform="translateY(6px)"; }, 2600);
    setTimeout(()=>{ el.remove(); }, 3200);
  }

  function setLoading(on, text="Working..."){
    loading.style.display = on ? "flex" : "none";
    loadingText.textContent = text;
    genBtn.disabled = on;
    startBtn.disabled = on;
    stopBtn.disabled = on || !mediaRecorder || mediaRecorder.state !== "recording";
    checkBtn.disabled = on || !recordedBlob || !passageBox.value.trim();
  }

  async function checkBackend(){
    try{
      const r = await fetch(`${API_BASE}/`);
      if(!r.ok) throw new Error("not ok");
      apiStatus.textContent = "üü¢ Backend: Connected";
      apiStatus.className = "pill badgeOk";
      return true;
    }catch(e){
      apiStatus.textContent = "üî¥ Reading Fluency";
      apiStatus.className = "pill badgeBad";
      return false;
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  async function generatePassage(){
    if(!(await checkBackend())){
      toast("Backend not running. Start FastAPI first.");
      return;
    }

    setLoading(true, "Generating passage...");
    recordedBlob = null;
    checkBtn.disabled = true;

    try{
      const payload = {
        class_level: classSel.value,
        language: langSel.value,
        level: levelSel.value,
        chapter: chapterInput.value.trim(),
        subject: "Auto"
      };

      const r = await fetch(`${API_BASE}/api/generate_passage`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const res = await r.json();
      if(!r.ok) throw new Error(res.detail || "Passage error");

      const data = res.data;
      passageBox.value = `${data.title}\n\n${data.passage}`;

      toast("Passage ready! Now record.");

    }catch(e){
      toast(String(e.message || e));
    }finally{
      setLoading(false);
    }
  }

  async function startRecording(){
    if(!passageBox.value.trim()){
      toast("Generate passage first.");
      return;
    }

    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioChunks = [];
      recordedBlob = null;
      durationSeconds = 0;

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (e) => {
        if(e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(audioChunks, { type: "audio/webm" });
        checkBtn.disabled = false;
        toast("Recording saved. Now check fluency.");
      };

      recordStartTime = Date.now();
      mediaRecorder.start();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      toast("Recording started...");

    }catch(e){
      toast("Mic permission denied or not available.");
    }
  }

  function stopRecording(){
    if(mediaRecorder && mediaRecorder.state === "recording"){
      mediaRecorder.stop();
      durationSeconds = Math.max(1, Math.round((Date.now() - recordStartTime) / 1000));
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  async function checkFluency(){
    if(!recordedBlob){
      toast("Record audio first.");
      return;
    }

    const fullText = passageBox.value.trim();
    const expected_text = fullText.split("\n").slice(2).join("\n").trim() || fullText;

    setLoading(true, "Checking fluency...");

    try{
      const fd = new FormData();
      fd.append("expected_text", expected_text);
      fd.append("class_level", classSel.value);
      fd.append("language", langSel.value);
      fd.append("duration_seconds", String(durationSeconds));
      fd.append("audio", recordedBlob, "audio.webm");

      const r = await fetch(`${API_BASE}/api/check_fluency`, {
        method: "POST",
        body: fd
      });

      const res = await r.json();
      if(!r.ok) throw new Error(res.detail || "Fluency check error");

      const m = res.metrics;

      out.innerHTML = `
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
          <div class="pill">üéØ Accuracy: <span class="bigNum">${escapeHtml(m.accuracy)}</span>%</div>
          <div class="pill">‚è± WPM: <span class="bigNum">${escapeHtml(m.wpm)}</span></div>
          <div class="pill">‚≠ê Fluency: <b>${escapeHtml(m.fluency)}</b></div>
        </div>

        <div class="divider"></div>

        <div class="resultCard">
          <h3>Spoken Text</h3>
          <div class="resultText">${escapeHtml(res.spoken_text)}</div>
        </div>

        <div class="resultCard">
          <h3>Mistakes</h3>
          <div class="resultText">
<b>Missing words:</b> ${(res.mistakes.missing_words || []).join(", ") || "None"}

<b>Extra words:</b> ${(res.mistakes.extra_words || []).join(", ") || "None"}

<b>Wrong words:</b> ${
  (res.mistakes.wrong_words || []).length
    ? (res.mistakes.wrong_words || []).map(x=>`${x.expected} ‚Üí ${x.spoken}`).join(" | ")
    : "None"
}
          </div>
        </div>

        <div class="resultCard">
          <h3>Teacher Feedback</h3>
          <div class="resultText">
${(res.feedback || []).map(x=>`‚Ä¢ ${escapeHtml(x)}`).join("\n")}
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted">Saved ID: ${escapeHtml(res.saved_id || "Not saved")}</div>
      `;

      toast("Fluency report ready!");

    }catch(e){
      toast(String(e.message || e));
    }finally{
      setLoading(false);
    }
  }

  genBtn.addEventListener("click", generatePassage);
  startBtn.addEventListener("click", startRecording);
  stopBtn.addEventListener("click", stopRecording);
  checkBtn.addEventListener("click", checkFluency);

  (async function init(){
    await checkBackend();
  })();
</script>

</body>
</html>